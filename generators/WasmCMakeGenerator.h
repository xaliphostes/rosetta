#pragma once
#include "CodeWriter.h"

// ============================================================================
// WASM CMakeLists.txt Generator (for Emscripten)
// ============================================================================

class WasmCMakeGenerator : public CodeWriter {
public:
    using CodeWriter::CodeWriter;

    void generate() override {
        write_header();
        write_project();
        write_emscripten_check();
        write_sources();
        write_compile_options();
        write_link_options();
        write_install();
    }

private:
    void write_header() {
        line("# ============================================================================");
        line("# AUTO-GENERATED CMakeLists.txt for WASM - DO NOT EDIT");
        line("# Generated by binding_generator");
        line("# Build with: emcmake cmake -B build && cmake --build build");
        line("# ============================================================================");
        line();
    }

    void write_project() {
        line("cmake_minimum_required(VERSION 3.16)");
        line("project(" + config_.module_name + "_wasm VERSION " + config_.version + " LANGUAGES CXX)");
        line();
        line("set(CMAKE_CXX_STANDARD 17)");
        line("set(CMAKE_CXX_STANDARD_REQUIRED ON)");
        line();
        line("set(MODULE_NAME \"" + config_.module_name + "\")");
        line();
    }

    void write_emscripten_check() {
        line("# Verify Emscripten");
        line("if(NOT EMSCRIPTEN)");
        indent();
        line("message(FATAL_ERROR \"This project must be built with Emscripten. Use: emcmake cmake ...\")");
        dedent();
        line("endif()");
        line();
    }

    void write_sources() {
        line("# WASM module");
        line("add_executable(${MODULE_NAME}");
        indent();
        line("generated_embind.cxx");
        dedent();
        line(")");
        line();
        
        line("# Include directories");
        line("target_include_directories(${MODULE_NAME} PRIVATE");
        indent();
        line("${CMAKE_CURRENT_SOURCE_DIR}");
        for (const auto& dir : config_.include_dirs) {
            line("\"" + dir + "\"");
        }
        dedent();
        line(")");
        line();
        
        if (!config_.link_libraries.empty()) {
            line("# Link libraries");
            line("target_link_libraries(${MODULE_NAME} PRIVATE");
            indent();
            for (const auto& lib : config_.link_libraries) {
                line(lib);
            }
            dedent();
            line(")");
            line();
        }
    }

    void write_compile_options() {
        line("# Emscripten compile options");
        line("target_compile_options(${MODULE_NAME} PRIVATE");
        indent();
        line("-fexceptions");
        line("-sNO_DISABLE_EXCEPTION_CATCHING");
        dedent();
        line(")");
        line();
    }

    void write_link_options() {
        line("# Emscripten link options");
        line("target_link_options(${MODULE_NAME} PRIVATE");
        indent();
        line("--bind");
        line("-sWASM=1");
        line("-sMODULARIZE=1");
        line("-sEXPORT_NAME='create${MODULE_NAME}'");
        line("-sALLOW_MEMORY_GROWTH=1");
        line("-sEXPORTED_RUNTIME_METHODS=['ccall','cwrap']");
        line("-fexceptions");
        line("-sNO_DISABLE_EXCEPTION_CATCHING");
        dedent();
        line(")");
        line();
        
        line("# Output settings");
        line("set_target_properties(${MODULE_NAME} PROPERTIES");
        indent();
        line("SUFFIX \".js\"");
        line("RUNTIME_OUTPUT_DIRECTORY \"${CMAKE_BINARY_DIR}\"");
        dedent();
        line(")");
        line();
    }

    void write_install() {
        line("# Installation");
        line("install(FILES");
        indent();
        line("${CMAKE_BINARY_DIR}/${MODULE_NAME}.js");
        line("${CMAKE_BINARY_DIR}/${MODULE_NAME}.wasm");
        if (config_.generate_typescript) {
            line("${CMAKE_CURRENT_SOURCE_DIR}/${MODULE_NAME}.d.ts");
        }
        dedent();
        line("DESTINATION .");
        line(")");
    }
};
