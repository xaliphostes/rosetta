#pragma once
#include "../CodeWriter.h"

// ============================================================================
// REST API CMakeLists.txt Generator
// ============================================================================

class RestApiCMakeGenerator : public CodeWriter {
public:
    using CodeWriter::CodeWriter;

    void generate() override {
        write_header();
        write_project();
        write_dependencies();
        write_executable();
        write_install();
    }

private:
    void write_header() {
        line("# ============================================================================");
        line("# AUTO-GENERATED CMakeLists.txt for REST API - DO NOT EDIT");
        line("# Generated by binding_generator");
        line("# ============================================================================");
        line();
    }

    void write_project() {
        line("cmake_minimum_required(VERSION 3.16)");
        line("project(" + config_.module_name + "_rest VERSION " + config_.version + " LANGUAGES CXX)");
        line();
        line("set(CMAKE_CXX_STANDARD 20)");
        line("set(CMAKE_CXX_STANDARD_REQUIRED ON)");
        line();
        line("set(MODULE_NAME \"" + config_.module_name + "_server\")");
        line();
    }

    void write_dependencies() {
        line("# ============================================================================");
        line("# Dependencies");
        line("# ============================================================================");
        line();
        
        // nlohmann_json
        line("# JSON library");
        line("find_package(nlohmann_json 3.9 QUIET)");
        line("if(NOT nlohmann_json_FOUND)");
        indent();
        line("include(FetchContent)");
        line("FetchContent_Declare(");
        indent();
        line("nlohmann_json");
        line("GIT_REPOSITORY https://github.com/nlohmann/json.git");
        line("GIT_TAG v3.11.2");
        dedent();
        line(")");
        line("FetchContent_MakeAvailable(nlohmann_json)");
        dedent();
        line("endif()");
        line();

        // cpp-httplib
        line("# HTTP library (header-only)");
        line("find_path(HTTPLIB_INCLUDE_DIR httplib.h)");
        line("if(NOT HTTPLIB_INCLUDE_DIR)");
        indent();
        line("include(FetchContent)");
        line("FetchContent_Declare(");
        indent();
        line("httplib");
        line("GIT_REPOSITORY https://github.com/yhirose/cpp-httplib.git");
        line("GIT_TAG v0.14.1");
        dedent();
        line(")");
        line("FetchContent_MakeAvailable(httplib)");
        line("set(HTTPLIB_INCLUDE_DIR ${httplib_SOURCE_DIR})");
        dedent();
        line("endif()");
        line();

        // Threads
        line("# Threading support");
        line("find_package(Threads REQUIRED)");
        line();

        // OpenSSL (optional, for HTTPS)
        line("# OpenSSL (optional, for HTTPS support)");
        line("find_package(OpenSSL QUIET)");
        line("if(OpenSSL_FOUND)");
        indent();
        line("message(STATUS \"OpenSSL found - HTTPS support enabled\")");
        line("add_definitions(-DCPPHTTPLIB_OPENSSL_SUPPORT)");
        dedent();
        line("else()");
        indent();
        line("message(STATUS \"OpenSSL not found - HTTP only\")");
        dedent();
        line("endif()");
        line();
    }

    void write_executable() {
        line("# ============================================================================");
        line("# REST API Server Executable");
        line("# ============================================================================");
        line();
        line("add_executable(${MODULE_NAME}");
        indent();
        line("generated_rest_api.cxx");
        dedent();
        line(")");
        line();

        line("target_include_directories(${MODULE_NAME} PRIVATE");
        indent();
        line("${CMAKE_CURRENT_SOURCE_DIR}");
        line("${HTTPLIB_INCLUDE_DIR}");
        for (const auto& dir : config_.include_dirs) {
            line("\"" + dir + "\"");
        }
        dedent();
        line(")");
        line();

        line("target_link_libraries(${MODULE_NAME} PRIVATE");
        indent();
        line("nlohmann_json::nlohmann_json");
        line("Threads::Threads");
        for (const auto& lib : config_.link_libraries) {
            line(lib);
        }
        dedent();
        line(")");
        line();

        line("if(OpenSSL_FOUND)");
        indent();
        line("target_link_libraries(${MODULE_NAME} PRIVATE OpenSSL::SSL OpenSSL::Crypto)");
        dedent();
        line("endif()");
        line();

        line("# Platform-specific settings");
        line("if(WIN32)");
        indent();
        line("target_link_libraries(${MODULE_NAME} PRIVATE ws2_32)");
        dedent();
        line("endif()");
        line();
    }

    void write_install() {
        line("# ============================================================================");
        line("# Installation");
        line("# ============================================================================");
        line();
        line("install(TARGETS ${MODULE_NAME}");
        indent();
        line("RUNTIME DESTINATION bin");
        dedent();
        line(")");
    }
};
