#pragma once
#include "../CodeWriter.h"

// ============================================================================
// Python CMakeLists.txt Generator
// ============================================================================

class PythonCMakeGenerator : public CodeWriter {
public:
    using CodeWriter::CodeWriter;

    void generate() override {
        write_header();
        write_project();
        write_python_config();
        write_pybind11_config();
        write_module();
        write_install();
    }

private:
    void write_header() {
        line("# ============================================================================");
        line("# AUTO-GENERATED CMakeLists.txt - DO NOT EDIT");
        line("# Generated by binding_generator");
        line("# ============================================================================");
        line();
    }

    void write_project() {
        line("cmake_minimum_required(VERSION 3.16)");
        line("project(" + config_.module_name + "_python VERSION " + config_.version + " LANGUAGES CXX)");
        line();
        line("set(CMAKE_CXX_STANDARD 20)");
        line("set(CMAKE_CXX_STANDARD_REQUIRED ON)");
        line("set(CMAKE_POSITION_INDEPENDENT_CODE ON)");
        line();
        line("set(MODULE_NAME \"" + config_.module_name + "\")");
        line();
    }

    void write_python_config() {
        line("# Find Python");
        line("find_package(Python REQUIRED COMPONENTS Interpreter Development)");
        line();
    }

    void write_pybind11_config() {
        line("# Find or fetch pybind11");
        line("find_package(pybind11 CONFIG QUIET)");
        line("if(NOT pybind11_FOUND)");
        indent();
        line("include(FetchContent)");
        line("FetchContent_Declare(");
        indent();
        line("pybind11");
        line("GIT_REPOSITORY https://github.com/pybind/pybind11.git");
        line("GIT_TAG v2.11.1");
        dedent();
        line(")");
        line("FetchContent_MakeAvailable(pybind11)");
        dedent();
        line("endif()");
        line();
    }

    void write_module() {
        line("# Create Python module");
        line("pybind11_add_module(${MODULE_NAME}");
        indent();
        line("generated_pybind11.cxx");
        dedent();
        line(")");
        line();
        
        line("# Include directories");
        line("target_include_directories(${MODULE_NAME} PRIVATE");
        indent();
        line("${CMAKE_CURRENT_SOURCE_DIR}");
        for (const auto& dir : config_.include_dirs) {
            line("\"" + dir + "\"");
        }
        dedent();
        line(")");
        line();
        
        if (!config_.library_dirs.empty()) {
            line("# Library directories");
            line("target_link_directories(${MODULE_NAME} PRIVATE");
            indent();
            for (const auto& dir : config_.library_dirs) {
                line("\"" + dir + "\"");
            }
            dedent();
            line(")");
            line();
        }
        
        if (!config_.link_libraries.empty()) {
            line("# Link libraries");
            line("target_link_libraries(${MODULE_NAME} PRIVATE");
            indent();
            for (const auto& lib : config_.link_libraries) {
                line(lib);
            }
            dedent();
            line(")");
            line();
        }
        
        line("# Platform-specific settings");
        line("if(WIN32 AND Python_LIBRARIES)");
        indent();
        line("target_link_libraries(${MODULE_NAME} PRIVATE ${Python_LIBRARIES})");
        dedent();
        line("endif()");
        line();
        
        line("set_target_properties(${MODULE_NAME} PROPERTIES");
        indent();
        line("LIBRARY_OUTPUT_DIRECTORY \"${CMAKE_BINARY_DIR}\"");
        line("RUNTIME_OUTPUT_DIRECTORY \"${CMAKE_BINARY_DIR}\"");
        dedent();
        line(")");
        line();
        
        line("if(WIN32)");
        indent();
        line("set_target_properties(${MODULE_NAME} PROPERTIES SUFFIX \".pyd\")");
        dedent();
        line("endif()");
        line();
    }

    void write_install() {
        line("# Installation");
        line("install(TARGETS ${MODULE_NAME}");
        indent();
        line("LIBRARY DESTINATION .");
        line("RUNTIME DESTINATION .");
        dedent();
        line(")");
        line();
        
        if (config_.generate_stubs) {
            line("# Install type stubs");
            line("install(FILES ${CMAKE_CURRENT_SOURCE_DIR}/${MODULE_NAME}.pyi");
            indent();
            line("DESTINATION .");
            dedent();
            line(")");
        }
    }
};